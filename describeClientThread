/*
 * ========= IMPORTS =========
 */
import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.channels.FileChannel;
import java.nio.channels.SocketChannel;
import java.io.DataInputStream;     // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á" (long)
import java.io.DataOutputStream;    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á" (String, long)
import java.io.RandomAccessFile; // ‚¨ÖÔ∏è ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏´‡∏•‡∏±‡∏Å: "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î"
import java.util.ArrayList;         // ‚¨ÖÔ∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ "‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô"
import java.util.List;              // ‚¨ÖÔ∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ "‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô"

/**
 * ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ Client ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô "Chunked" (‡πÅ‡∏ö‡∏ö "‡∏£‡∏∏‡∏°")
 * ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏≤‡∏¢‡πÜ ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô
 * (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö ZeroCopyServer_Chunked ‡∏´‡∏£‡∏∑‡∏≠ ZeroCopyServer_ThreadPool ‡∏Å‡πá‡πÑ‡∏î‡πâ)
 */
public class ZeroCopyClient_Chunked {

    /*
     * ========= CONFIGURATION (‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤) =========
     */
    static final String HOST = "localhost"; // ‚¨ÖÔ∏è Server ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô
    static final int PORT = 9999;           // ‚¨ÖÔ∏è Server ‡πÉ‡∏ä‡πâ Port ‡∏≠‡∏∞‡πÑ‡∏£
    static final String FILE_TO_SAVE = "..\\\\FileSave\\\\TestFileDownloadedZeroCopy"; // ‚¨ÖÔ∏è ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£
    
    // ‚¨áÔ∏è ‚¨áÔ∏è ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á Client ‚¨áÔ∏è ‚¨áÔ∏è
    static final int NUM_THREADS = 8; // ‚¨ÖÔ∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô "‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô" (Threads) ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ "‡∏£‡∏∏‡∏°"

    /*
     * ========= MAIN (‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ üß†) =========
     */
    public static void main(String[] args) throws IOException, InterruptedException {

        System.out.println("Chunked Client Started...");
        System.out.println("Will connect to " + HOST + ":" + PORT + " with " + NUM_THREADS + " threads.");
        long startTime = System.currentTimeMillis();

        // --------------------------------------
        // Phase 1: "‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô" (‡∏ñ‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå)
        // --------------------------------------
        long fileSize = getFileSize(); // (‡∏î‡∏π‡πÄ‡∏°‡∏ò‡∏≠‡∏î getFileSize() ‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á)
        if (fileSize == -1) {
            System.err.println("Could not get file size. Aborting.");
            return;
        }
        System.out.println("Total file size: " + fileSize + " bytes (" + (fileSize / 1024 / 1024) + " MB)");

        // --------------------------------------
        // Phase 2: "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà"
        // --------------------------------------
        // ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á "‡∏à‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà" ‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏ô‡∏î‡∏¥‡∏™‡∏Å‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô
        // ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ "RandomAccessFile" ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏±‡∏ô‡∏ó‡∏≥‡πÑ‡∏î‡πâ
        try (RandomAccessFile raf = new RandomAccessFile(FILE_TO_SAVE, "rw")) {
            raf.setLength(fileSize); // "‡∏¢‡∏∑‡∏î" ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤ fileSize (‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤)
        }
        System.out.println("Created placeholder file: " + FILE_TO_SAVE);

        // --------------------------------------
        // Phase 3: "‡πÅ‡∏ö‡πà‡∏á‡∏á‡∏≤‡∏ô"
        // --------------------------------------
        long partSize = fileSize / NUM_THREADS; // 1 ‡∏á‡∏≤‡∏ô (1 Thread) ‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏µ‡πà‡πÑ‡∏ö‡∏ï‡πå
        long currentStart = 0; // ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡∏Å
        List<Thread> threads = new ArrayList<>(); // "‡∏™‡∏°‡∏∏‡∏î‡∏à‡∏î" ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô

        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡∏à‡πâ‡∏≤‡∏á‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô" 8 ‡∏Ñ‡∏ô
        for (int i = 0; i < NUM_THREADS; i++) {
            
            long currentEnd;
            if (i == NUM_THREADS - 1) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô "‡∏Ñ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢" ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                // (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ï‡∏±‡∏ß)
                currentEnd = fileSize - 1; 
            } else {
                currentEnd = currentStart + partSize - 1;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á "‡πÉ‡∏ö‡∏á‡∏≤‡∏ô" (Runnable)
            Runnable worker = new FileDownloaderHandler(currentStart, currentEnd);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á "‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô" (Thread) ‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡πà‡∏ô "‡πÉ‡∏ö‡∏á‡∏≤‡∏ô" ‡πÉ‡∏´‡πâ
            Thread t = new Thread(worker);
            t.start(); // ‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô" (‡πÑ‡∏õ‡∏ó‡∏µ‡πà run() ‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á)
            threads.add(t); // "‡∏à‡∏î‡∏ä‡∏∑‡πà‡∏≠" ‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô List

            System.out.println("  Started Thread " + i + ": (bytes " + currentStart + " to " + currentEnd + ")");
            
            // ‡∏Ç‡∏¢‡∏±‡∏ö‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ
            currentStart += partSize; 
        }

        // --------------------------------------
        // Phase 4: "‡∏£‡∏≠‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô"
        // --------------------------------------
        // "‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£" (Main Thread) ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤ "‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô" ‡∏ó‡∏±‡πâ‡∏á 8 ‡∏Ñ‡∏ô‡∏à‡∏∞‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à
        for (Thread t : threads) {
            t.join(); // .join() ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£ "‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≠" ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤ Thread t ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ï‡∏≤‡∏¢ (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à)
        }

        // --- ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à ---
        long endTime = System.currentTimeMillis();
        System.out.println("\nDownload complete!");
        System.out.println("Total time: " + (endTime - startTime) + " ms");
    }

    /**
     * ‡πÄ‡∏°‡∏ò‡∏≠‡∏î‡∏ä‡πà‡∏ß‡∏¢: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server "‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏≤‡∏° "SIZE"
     */
    private static long getFileSize() throws IOException {
        // ‡πÉ‡∏ä‡πâ try-with-resources ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Socket ‡∏õ‡∏¥‡∏î‡πÄ‡∏≠‡∏á
        try (SocketChannel socketChannel = SocketChannel.open(new InetSocketAddress(HOST, PORT));
             DataInputStream in = new DataInputStream(socketChannel.socket().getInputStream());
             DataOutputStream out = new DataOutputStream(socketChannel.socket().getOutputStream())) {

            // 1. ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á "SIZE"
            out.writeUTF("SIZE"); 
            out.flush();
            
            // 2. ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå)
            return in.readLong(); 

        } catch (IOException e) {
            System.err.println("Error getting file size: " + e.getMessage());
            return -1; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ -1 ‡∏ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
        }
    }

    /*
     * ========= FileDownloaderHandler (‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î üë∑) =========
     *
     * ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ "‡πÉ‡∏ö‡∏á‡∏≤‡∏ô" (Runnable) ‡∏ó‡∏µ‡πà "‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô" (Thread) ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô‡∏à‡∏∞‡∏ó‡∏≥
     * ‡∏°‡∏±‡∏ô‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô" ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢
     */
    public static class FileDownloaderHandler implements Runnable {
        private long start; // ‡πÑ‡∏ö‡∏ï‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö)
        private long end;   // ‡πÑ‡∏ö‡∏ï‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö)

        public FileDownloaderHandler(long start, long end) {
            this.start = start;
            this.end = end;
        }

        @Override
        public void run() {
            // "‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô" (Thread) ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            try (
                // 1. "‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô" ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÉ‡∏´‡∏°‡πà" (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!)
                SocketChannel serverSocket = SocketChannel.open(new InetSocketAddress(HOST, PORT));
                
                // 2. ‡πÄ‡∏õ‡∏¥‡∏î "‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" (‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà main ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
                //    "rw" = Read/Write mode
                RandomAccessFile raf = new RandomAccessFile(FILE_TO_SAVE, "rw");
                
                // 3. ‡πÄ‡∏≠‡∏≤ FileChannel ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å RandomAccessFile
                FileChannel fc = raf.getChannel(); 
                
                // 4. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Stream ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á"
                DataOutputStream out = new DataOutputStream(serverSocket.socket().getOutputStream())
            ) {
                // 5. ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á "GET" ‡πÅ‡∏•‡∏∞ "‡∏ä‡πà‡∏ß‡∏á" ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                out.writeUTF("GET");    // (Server ‡∏à‡∏∞‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏á‡∏≤‡∏ô "‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á")
                out.writeLong(start); // ‡∏™‡πà‡∏á "‡πÑ‡∏ö‡∏ï‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô"
                out.writeLong(end);   // ‡∏™‡πà‡∏á "‡πÑ‡∏ö‡∏ï‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢"
                out.flush();
                
                // 6. üåü ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏´‡∏•‡∏±‡∏Å: Zero Copy (transferFrom) + Random Access üåü
                //    ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ "‡∏î‡∏π‡∏î" ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Server ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô "‡∏™‡πà‡∏ß‡∏ô" ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
                long total = 0; // ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏î‡∏π‡∏î‡∏°‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡πâ‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
                long size = end - start + 1; // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡πâ‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡∏î
                
                while (total < size) {
                    // fc.transferFrom(source, position, count)
                    //   source:   ‡∏î‡∏π‡∏î‡∏à‡∏≤‡∏Å "serverSocket"
                    //   position: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô" ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á "start + total"
                    //   count:    ‡∏î‡∏π‡∏î‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô "size - total" (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
                    long transferred = fc.transferFrom(serverSocket, start + total, size - total);
                    
                    if (transferred <= 0 && total < size) {
                         // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Server ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏±‡∏ô
                         throw new IOException("Server stopped sending data unexpectedly.");
                    }
                    total += transferred;
                }
                
                // System.out.println("  Finished Thread (bytes " + start + " to " + end + ")");

            } catch (Exception e) {
                // ‡∏ñ‡πâ‡∏≤ Thread (‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô) ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
                System.err.println("  Error in Thread (bytes " + start + "): " + e.getMessage());
            }
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ "run()" ‡∏à‡∏ö "‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô" (Thread) ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πá‡∏ï‡∏≤‡∏¢ (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à)
        }
    }
}
